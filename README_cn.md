# ComfyUI 盲水印插件

一个强大的 ComfyUI 盲水印插件，允许您使用频域技术（DWT-DCT-SVD）在图像中嵌入和提取不可见的水印。

[![Python](https://img.shields.io/badge/python->=3.5-green.svg)](https://www.python.org/)
[![Platform](https://img.shields.io/badge/platform-windows%20|%20linux%20|%20macos-green.svg)](https://github.com/guofei9987/blind_watermark)

## 功能特性

- 🔒 **不可见水印**：嵌入人眼无法察觉的水印
- 📝 **文本水印**：嵌入和提取文本信息
- 🖼️ **图像水印**：嵌入和提取图像水印
- 📲 **二维码支持**：生成和解码二维码以实现高级水印功能
- 🛡️ **鲁棒性强**：抵抗常见图像操作（旋转、裁剪、缩放、压缩）
- ⚙️ **高级控制**：精细调整嵌入强度、DCT 系数和处理模式
- 🎨 **ComfyUI 集成**：与原生节点无缝集成工作流

## 安装步骤

### 1. 安装插件

导航到您的 ComfyUI 自定义节点目录并克隆此仓库：

```bash
cd ComfyUI/custom_nodes
git clone https://github.com/YOUR_USERNAME/Comfyui_blind_watermark.git
```

### 2. 安装依赖

安装所需的 Python 包：

```bash
cd Comfyui_blind_watermark
pip install -r requirements.txt
```

**必需的包：**
- `blind-watermark` - 核心水印库
- `qrcode` - 二维码生成
- `pillow` - 图像处理
- `pyzbar`（可选）- 二维码解码

### 3. 重启 ComfyUI

重启 ComfyUI 以加载新节点。

## 可用节点

### 水印节点

1. **📝 嵌入文本水印**
   - 将不可见文本嵌入图像
   - 可配置嵌入强度（d1, d2）
   - 支持多种 DCT 系数模式

2. **📖 提取文本水印**
   - 从水印图像中提取嵌入的文本
   - 需要匹配的密码和长度参数
   - 提供详细的提取信息

3. **🖼️ 嵌入图像水印**
   - 将不可见的图像水印嵌入到另一张图像中
   - 支持 PNG、JPEG 等格式
   - 可配置透明度混合

4. **🔍 提取图像水印**
   - 提取嵌入的图像水印
   - 需要水印尺寸（宽×高）
   - 输出提取的水印图像张量

### 二维码节点

5. **📲 生成二维码**
   - 从文本/URL 创建二维码
   - 可调整大小和纠错级别
   - 输出图像张量供进一步处理

6. **🔍 解码二维码**
   - 从图像中解码二维码
   - 自动检测和提取
   - 返回解码的文本/URL

## 快速入门指南

### 示例 1：文本水印工作流

**嵌入文本：**
1. 使用"Load Image"节点加载图像
2. 添加"📝 嵌入文本水印"节点
3. 连接图像并输入：
   - **水印文本**："版权所有 2025"
   - **密码**：12345
   - **d1/d2**：使用默认值（36/20）或调整
4. 保存带水印的图像

**提取文本：**
1. 加载带水印的图像
2. 添加"📖 提取文本水印"节点
3. 输入相同的密码和文本长度
4. 在输出中查看提取的文本

### 示例 2：图像水印工作流

**嵌入图像：**
1. 加载原始图像
2. 加载您的水印/标志图像
3. 添加"🖼️ 嵌入图像水印"节点
4. 连接两个图像
5. 设置密码和嵌入强度
6. 保存结果

**提取图像：**
1. 加载带水印的图像
2. 添加"🔍 提取图像水印"节点
3. 输入密码和水印尺寸
4. 查看提取的水印

### 示例 3：二维码水印

1. 使用"📲 生成二维码"生成二维码
2. 使用"🖼️ 嵌入图像水印"将其作为水印
3. 使用"🔍 提取图像水印" → "🔍 解码二维码"提取和解码

## 参数说明

### 密码参数
- **password_img**：图像加密密码（整数）
- **password_wm**：水印加密密码（整数）
- 嵌入和提取操作之间的密码必须匹配

### 嵌入强度（d1/d2）
- **d1**：控制频率系数范围（默认：36）
- **d2**：控制嵌入强度（默认：20）
- **值越高** = 水印越强，越可见
- **值越低** = 水印越弱，越不可见
- 推荐：d1=36，d2=20 以获得平衡结果

### DCT 系数模式
- **模式 1**：使用较少的系数（更快，鲁棒性较低）
- **模式 2**：使用更多的系数（较慢，鲁棒性更强）
- **模式 3**：使用更多的系数（最慢，鲁棒性最强）

### 处理模式
- **单进程**：标准处理
- **多核**：并行处理以加快嵌入速度
- **全部核心**：使用所有可用的 CPU 核心

## 水印鲁棒性

该水印技术能够抵抗：

| 攻击类型 | 鲁棒性 | 备注 |
|---------|-------|------|
| 🔄 旋转 | ⭐⭐⭐⭐ | 抵抗适度旋转 |
| ✂️ 裁剪 | ⭐⭐⭐⭐⭐ | 高度抵抗 |
| 📏 缩放 | ⭐⭐⭐⭐⭐ | 抵抗调整大小操作 |
| 🎭 遮挡 | ⭐⭐⭐⭐ | 部分水印仍可恢复 |
| 📦 压缩 | ⭐⭐⭐⭐ | 抵抗 JPEG 压缩 |
| 🌈 亮度/对比度 | ⭐⭐⭐⭐⭐ | 不受颜色调整影响 |
| 🔊 噪声 | ⭐⭐⭐ | 中等抵抗能力 |

## 技巧和最佳实践

### 获得最佳效果：

1. **密码管理**
   - 嵌入和提取使用相同的密码
   - 安全记录密码
   - 密码值越高 = 安全性越高

2. **水印长度**
   - 保持文本水印简洁（< 100 字符）
   - 较长的水印需要更大的图像
   - 记录嵌入后报告的 `wm_bit_length`

3. **图像质量**
   - 使用高分辨率图像（最小 512×512）
   - 避免使用高度压缩的图像作为输入
   - 以无损格式（PNG）保存带水印的图像

4. **嵌入强度**
   - 从默认值开始（d1=36，d2=20）
   - 如果提取失败，增加 d2
   - 如果水印可见，减少 d2

5. **图像水印**
   - 使用简单、高对比度的水印图像
   - 推荐水印大小：64×64 或 128×128
   - 黑白标志效果最佳

## 故障排除

### 水印提取失败

**问题**：提取的文本乱码或为空

**解决方案：**
- ✅ 验证密码完全匹配
- ✅ 检查 `wm_bit_length` 参数
- ✅ 确保图像没有被多次重新编码
- ✅ 尝试增加嵌入强度（d2）
- ✅ 嵌入和提取使用相同的 DCT 模式

### 水印在图像中可见

**问题**：水印产生可见的伪影

**解决方案：**
- ✅ 降低 d2 参数（例如，从 20 降到 15）
- ✅ 使用更小的水印
- ✅ 确保输入图像质量高

### 节点未出现

**问题**：节点未在 ComfyUI 中显示

**解决方案：**
- ✅ 检查 `requirements.txt` 中的包是否已安装
- ✅ 完全重启 ComfyUI
- ✅ 检查控制台的错误消息
- ✅ 验证文件夹位于 `ComfyUI/custom_nodes/` 中

## 技术细节

该插件使用基于以下技术的频域水印：
- **DWT**（离散小波变换）
- **DCT**（离散余弦变换）
- **SVD**（奇异值分解）

水印嵌入在频域中，使其对人眼不可见，同时可以使用正确的密码进行检测。

## 致谢

基于 [@guofei9987](https://github.com/guofei9987) 的优秀 [blind_watermark](https://github.com/guofei9987/blind_watermark) 库。

## 相关项目

- **blind_watermark**：[https://github.com/guofei9987/blind_watermark](https://github.com/guofei9987/blind_watermark)
- **文本盲水印**：[https://github.com/guofei9987/text_blind_watermark](https://github.com/guofei9987/text_blind_watermark)
- **HideInfo**：[https://github.com/guofei9987/HideInfo](https://github.com/guofei9987/HideInfo)

## 许可证

本项目遵循原始 blind_watermark 库的许可证。详情请参阅 LICENSE 文件。

## 支持与贡献

- 🐛 **错误报告**：在 GitHub 上开启 issue
- 💡 **功能请求**：开启 issue 提出您的建议
- 🔧 **Pull Requests**：欢迎贡献！

---

**祝您水印愉快！🎨🔒**
